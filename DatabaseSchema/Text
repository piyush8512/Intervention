-- 1. Enable UUID Extension
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- 2. Create Enum for Status (CORRECTED: lowercase, matches code)
CREATE TYPE student_status AS ENUM ('normal', 'needs_intervention', 'remedial');

-- 3. Table: Students (The State Machine)
CREATE TABLE students (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    email TEXT NOT NULL UNIQUE, -- ADDED: Unique constraint
    status student_status DEFAULT 'normal',
    -- REMOVED: current_remedial_task (use JOIN instead)
    last_checkin TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. Table: Daily Logs (The History Data)
CREATE TABLE daily_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    quiz_score INT NOT NULL CHECK (quiz_score >= 0 AND quiz_score <= 10),
    focus_minutes INT NOT NULL CHECK (focus_minutes >= 0),
    passed BOOLEAN GENERATED ALWAYS AS (quiz_score > 7 AND focus_minutes > 60) STORED,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 5. Table: Interventions (The Audit Trail)
CREATE TABLE interventions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    task TEXT NOT NULL,
    assigned_by TEXT DEFAULT 'system',
    assigned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed BOOLEAN DEFAULT false,
    completed_at TIMESTAMP WITH TIME ZONE NULL
);

-- 6. Trigger to automatically update 'updated_at'
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

CREATE TRIGGER update_students_modtime
    BEFORE UPDATE ON students
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 7. Performance Indexes (ADDED)
CREATE INDEX idx_students_status ON students(status);
CREATE INDEX idx_students_email ON students(email);
CREATE INDEX idx_daily_logs_student ON daily_logs(student_id);
CREATE INDEX idx_daily_logs_created ON daily_logs(created_at DESC);
CREATE INDEX idx_interventions_student ON interventions(student_id);
CREATE INDEX idx_interventions_completed ON interventions(completed) WHERE completed = false;

-- 8. Useful Views (BONUS)
CREATE VIEW student_current_status AS
SELECT 
    s.id,
    s.name,
    s.email,
    s.status,
    s.last_checkin,
    i.task as current_task,
    i.assigned_at as task_assigned_at
FROM students s
LEFT JOIN interventions i ON s.id = i.student_id 
    AND i.completed = false
WHERE s.status = 'remedial'
ORDER BY s.last_checkin DESC;

-- 9. Function to get student with current task
CREATE OR REPLACE FUNCTION get_student_status(student_uuid UUID)
RETURNS TABLE (
    id UUID,
    name TEXT,
    email TEXT,
    status student_status,
    current_task TEXT,
    last_checkin TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        s.id,
        s.name,
        s.email,
        s.status,
        (SELECT i.task FROM interventions i 
         WHERE i.student_id = s.id AND i.completed = false 
         ORDER BY i.assigned_at DESC LIMIT 1) as current_task,
        s.last_checkin,
        s.created_at
    FROM students s
    WHERE s.id = student_uuid;
END;
$$ LANGUAGE plpgsql;